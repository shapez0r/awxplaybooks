---
# WinBatch V2 Debug - ĞÑ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ playbook Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼
- name: "ğŸ” WinBatch V2 Debug & Diagnostics"
  hosts: all
  gather_facts: false
  
  vars:
    ansible_shell_type: powershell
  
  tasks:
    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ SSH Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
    - name: "ğŸ”§ Test 1: Standard SSH connectivity"
      shell: echo "SSH connection test successful"
      connection: ssh
      register: ssh_test
      ignore_errors: true
      
    - name: "ğŸ“Š SSH Test Result"
      debug:
        msg: |
          SSH Test: {{ 'PASSED' if ssh_test.rc == 0 else 'FAILED' }}
          {% if ssh_test.failed %}
          Error: {{ ssh_test.msg | default('Unknown error') }}
          {% endif %}
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ PowerShell Ñ‡ĞµÑ€ĞµĞ· SSH
    - name: "ğŸ”§ Test 2: PowerShell via SSH"
      shell: powershell -Command "Write-Host 'PowerShell via SSH working'; Get-Date"
      connection: ssh
      register: ps_ssh_test
      ignore_errors: true
      
    - name: "ğŸ“Š PowerShell SSH Test Result"
      debug:
        msg: |
          PowerShell SSH Test: {{ 'PASSED' if ps_ssh_test.rc == 0 else 'FAILED' }}
          {% if ps_ssh_test.failed %}
          Error: {{ ps_ssh_test.msg | default('Unknown error') }}
          {% endif %}
          {% if not ps_ssh_test.failed %}
          Output: {{ ps_ssh_test.stdout }}
          {% endif %}
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ WinRM ĞºĞ°Ğº fallback
    - name: "ğŸ”§ Test 3: WinRM connectivity (fallback)"
      win_shell: |
        Write-Host "WinRM connection test successful"
        Get-Date
      connection: winrm
      register: winrm_test
      ignore_errors: true
      
    - name: "ğŸ“Š WinRM Test Result"
      debug:
        msg: |
          WinRM Test: {{ 'PASSED' if winrm_test.rc == 0 else 'FAILED' }}
          {% if winrm_test.failed %}
          Error: {{ winrm_test.msg | default('Unknown error') }}
          {% endif %}
          {% if not winrm_test.failed %}
          Output: {{ winrm_test.stdout }}
          {% endif %}
    
    # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ WinBatch V2 Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸
    - name: "ğŸš€ Test 4: WinBatch V2 Basic Test"
      win_shell: |
        Write-Host "WinBatch V2 basic test"
        $env:COMPUTERNAME
      connection: winbatch_v2
      vars:
        ansible_connection: winbatch_v2
        ansible_winbatch_batch_size: 1  # ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
        ansible_winbatch_status_interval: 10
        ansible_winbatch_execution_timeout: 300
        ansible_winbatch_ssh_timeout: 60
      register: winbatch_basic_test
      ignore_errors: true
      
    - name: "ğŸ“Š WinBatch V2 Basic Test Result"
      debug:
        msg: |
          WinBatch V2 Basic Test: {{ 'PASSED' if winbatch_basic_test.rc == 0 else 'FAILED' }}
          {% if winbatch_basic_test.failed %}
          Error: {{ winbatch_basic_test.msg | default('Unknown error') }}
          {% endif %}
          {% if not winbatch_basic_test.failed %}
          Output: {{ winbatch_basic_test.stdout }}
          {% endif %}
    
    # Ğ•ÑĞ»Ğ¸ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑˆĞµĞ», Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚Ğ½ÑƒÑ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ
    - name: "ğŸš€ Test 5: WinBatch V2 Batch Processing"
      block:
        - name: "Batch Task 1"
          win_shell: Write-Host "Batch task 1 - $(Get-Date)"
          connection: winbatch_v2
          vars:
            ansible_connection: winbatch_v2
            ansible_winbatch_batch_size: 3
          register: batch_task1
          
        - name: "Batch Task 2"
          win_shell: Write-Host "Batch task 2 - $env:COMPUTERNAME"
          connection: winbatch_v2
          register: batch_task2
          
        - name: "Batch Task 3"
          win_shell: Write-Host "Batch task 3 - $(Get-WmiObject Win32_OperatingSystem | Select-Object Caption)"
          connection: winbatch_v2
          register: batch_task3
          
      rescue:
        - name: "ğŸ“Š Batch Test Failed"
          debug:
            msg: "WinBatch V2 Batch Processing: FAILED - {{ ansible_failed_result.msg | default('Unknown error') }}"
      
      when: winbatch_basic_test.rc == 0
    
    # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
    - name: "ğŸ“‹ Final Diagnostic Report"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    ğŸ” WINBATCH V2 DIAGNOSTIC REPORT ğŸ”                     â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  ğŸ”§ SSH Connection: {{ 'PASSED' if ssh_test.rc == 0 else 'FAILED' }}                                              â•‘
          â•‘  ğŸ”§ PowerShell via SSH: {{ 'PASSED' if ps_ssh_test.rc == 0 else 'FAILED' }}                                      â•‘
          â•‘  ğŸ”§ WinRM Connection: {{ 'PASSED' if winrm_test.rc == 0 else 'FAILED' }}                                         â•‘
          â•‘  ğŸš€ WinBatch V2 Basic: {{ 'PASSED' if winbatch_basic_test.rc == 0 else 'FAILED' }}                               â•‘
          â•‘  ğŸš€ WinBatch V2 Batch: {{ 'PASSED' if (batch_task1.rc == 0 and batch_task2.rc == 0 and batch_task3.rc == 0) else 'FAILED' }}                               â•‘
          â•‘                                                                              â•‘
          â•‘  ğŸ“Š RECOMMENDATIONS:                                                         â•‘
          {% if ssh_test.rc != 0 %}
          â•‘     âŒ SSH connection failed - check OpenSSH Server on Windows              â•‘
          {% endif %}
          {% if ps_ssh_test.rc != 0 %}
          â•‘     âŒ PowerShell via SSH failed - check SSH shell configuration           â•‘
          {% endif %}
          {% if winrm_test.rc == 0 and winbatch_basic_test.rc != 0 %}
          â•‘     ğŸ’¡ WinRM works but WinBatch V2 fails - check plugin configuration      â•‘
          {% endif %}
          {% if winbatch_basic_test.rc == 0 %}
          â•‘     âœ… WinBatch V2 is working! You can use it for automation               â•‘
          {% endif %}
          â•‘                                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
    # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
    - name: "ğŸ” Additional Diagnostics"
      block:
        - name: "Check SSH service on Windows"
          win_shell: |
            try {
              $sshService = Get-Service -Name sshd -ErrorAction Stop
              Write-Host "SSH Service Status: $($sshService.Status)"
              Write-Host "SSH Service StartType: $($sshService.StartType)"
            } catch {
              Write-Host "SSH Service not found or not accessible"
            }
          connection: winrm
          register: ssh_service_check
          ignore_errors: true
          
        - name: "Check SSH configuration"
          win_shell: |
            $sshConfigPath = "C:\ProgramData\ssh\sshd_config"
            if (Test-Path $sshConfigPath) {
              Write-Host "SSH config file exists"
              $defaultShell = Get-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name DefaultShell -ErrorAction SilentlyContinue
              if ($defaultShell) {
                Write-Host "Default SSH Shell: $($defaultShell.DefaultShell)"
              } else {
                Write-Host "Default SSH Shell: Not configured (using cmd)"
              }
            } else {
              Write-Host "SSH config file not found"
            }
          connection: winrm
          register: ssh_config_check
          ignore_errors: true
          
        - name: "ğŸ“Š SSH Diagnostics"
          debug:
            msg: |
              SSH Service Check: {{ ssh_service_check.stdout | default('Failed to check') }}
              SSH Config Check: {{ ssh_config_check.stdout | default('Failed to check') }}
              
      when: winbatch_basic_test.rc != 0
      ignore_errors: true 